---
title: "Legionnaires' disease 2012-2019"
output:
  html_document:
  html_notebook:
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 10, fig.height = 5,
  echo=FALSE, warning=FALSE, message=FALSE)

##################### Settings ##################
rm(list=ls())

## load packages
library(tidyverse)
library(fpp3)
library(knitr)
library(kableExtra)
library(DT)
library(plotly)
library(forecast)
library(janitor)

## setting working directory   
PATH="C:/R/legi_analysis"

setwd(PATH)  

## open functions
source("Scripts/legi_functions.R")



######################### prepare the data ############################

## read in legi data and create aggregated data
legidata <- read_csv("Data/legi_agg_onset_4.csv",
                     col_type = list(col_character(), col_date(), col_date(), col_date(), 
                                     col_character(), col_double(), col_character(), col_character(), 
                                     col_character(), col_character(), col_character(),
                                     col_character(), col_character(), col_character(), 
                                     col_character(), col_character(), col_double()))

## create date variable
legidata <- legidata %>%
   mutate(date=case_when(is.na(DateOfOnsetISOdate_date)~DateUsedForStatisticsISO,
                                            TRUE~DateOfOnsetISOdate_date),
          date=case_when(is.na(date)~DateOfNotificationISOdate,
                         TRUE~date))

 completeness_dates <- legidata

## create Imported3
legidata <- legidata %>% 
  mutate(Imported3=case_when(Imported2=="UNK"~Imported,
                             TRUE~Imported2),
         Imported3=case_when(Imported3=="Y"~"Imported",
                              Imported3=="N"~"Not imported",
                              Imported3=="UNK"~"Unknown",
                              is.na(Imported3)~"Unknown"))

## create age groups
legidata$AgeGroup <- NA
legidata$AgeGroup[legidata$Age<20] <- "<20"
legidata$AgeGroup[legidata$Age>=20 & legidata$Age<30] <- "20-29"
legidata$AgeGroup[legidata$Age>=30 & legidata$Age<40] <- "30-39"
legidata$AgeGroup[legidata$Age>=40 & legidata$Age<50] <- "40-49"
legidata$AgeGroup[legidata$Age>=50 & legidata$Age<60] <- "50-59"
legidata$AgeGroup[legidata$Age>=60 & legidata$Age<70] <- "60-69"
legidata$AgeGroup[legidata$Age>=70 & legidata$Age<80] <- "70-79"
legidata$AgeGroup[legidata$Age>=80] <- "80>="
legidata$AgeGroup[is.na(legidata$Age)] <- "Unknown"

legidata$AgeGroup2 <- NA
legidata$AgeGroup2[legidata$Age<40] <- "<40"
legidata$AgeGroup2[legidata$Age>=40 & legidata$Age<50] <- "40-49"
legidata$AgeGroup2[legidata$Age>=50 & legidata$Age<60] <- "50-59"
legidata$AgeGroup2[legidata$Age>=60 & legidata$Age<70] <- "60-69"
legidata$AgeGroup2[legidata$Age>=70 & legidata$Age<80] <- "70-79"
legidata$AgeGroup2[legidata$Age>=80] <- "80>="
legidata$AgeGroup2[is.na(legidata$Age)] <- "Unknown"

legidata$AgeGroup3 <- NA
legidata$AgeGroup3[legidata$Age<65] <- "<65"
legidata$AgeGroup3[legidata$Age>=65] <- "65>="
legidata$AgeGroup3[is.na(legidata$Age)] <- "Unknown"


## add week and month
legidata$week <- yearweek(legidata$date)
legidata$month <- yearmonth(legidata$date)
legidata$date <- NULL

completeness_setting <- legidata

a <- legidata %>% summarise(sum(nb))

## remove dateless cases
legidata <- legidata[!is.na(legidata$week),]
b <- legidata %>% summarise(sum(nb))

## with all countries
legi_all <- legidata

## keeping Germany
legidata_de <- legidata %>% filter(CountryName!="Croatia" & CountryName!="Iceland" & 
                                   CountryName!="Luxembourg" & CountryName!="Bulgaria")

legidata <- legidata %>% filter(CountryName!="Croatia" & CountryName!="Iceland" & 
                                  CountryName!="Germany" & CountryName!="Luxembourg" & CountryName!="Bulgaria")
c <- legidata %>% summarise(sum(nb))

## count cases in week 45 2014 belonging to PT2014 outbreak
legidata %>% filter(week==yearweek("W45 2014")) %>% 
  group_by(ClusterID) %>% summarise(cases=sum(nb)) %>% 
  mutate(percent=100*cases/sum(cases))

## create data without PT2014 outbreak
legidata_nopt <- legidata[legidata$ClusterID!="206-VFX" | is.na(legidata$ClusterID),] ## is.na to include cases after 2014
d <- legidata_nopt %>% summarise(sum(nb))

## data without cluster cases
legidata_noc <- legidata[legidata$Cluster!="Y",] %>% filter(!is.na(nb))
e <- legidata_noc %>% summarise(sum(nb))

## data with only cluster cases
legidata_c <- legidata[legidata$Cluster=="Y",] %>% filter(!is.na(nb))
legidata_c <- legidata_c[legidata_c$ClusterID!="206-VFX" | is.na(legidata_c$ClusterID),] %>% filter(!is.na(nb))
f <- legidata_c %>% summarise(sum(nb))



## aggregate
agg_legidata <- legidata %>% group_by(CountryName, Imported3, Gender, AgeGroup2, week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legiall <- legi_all %>% group_by(CountryName, week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legidata_nopt <- legidata_nopt %>% group_by(CountryName, Imported3, Gender, AgeGroup2, week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legidata_noc <- legidata_noc %>% group_by(week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legidata_c <- legidata_c %>% group_by(week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legidata_de <- legidata_de %>% group_by(week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_monthly <- legidata %>% group_by(CountryName, Imported3, Gender, AgeGroup2, month) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_newage <- legidata_nopt %>% group_by(Imported3, AgeGroup3, week) %>%
  summarise(nb=sum(nb)) %>% ungroup()



################################################## create Legi tsibbles ###############################################
legi_tsibble <- agg_legidata %>%
  as_tsibble(index=week, 
             key=c(CountryName, Imported3, Gender, AgeGroup2)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata) ## remove aggregated data
legi_tsibble$nb[is.na(legi_tsibble$nb)] <- 0 ## fill missing weeks with 0 cases

legi_alltsibble <- agg_legiall %>%
  as_tsibble(index=week, 
             key=c(CountryName)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legiall)
legi_alltsibble$nb[is.na(legi_alltsibble$nb)] <- 0

## without PT outbreak
leginopt_tsibble <- agg_legidata_nopt %>%
  as_tsibble(index=week, 
             key=c(CountryName, Imported3, Gender, AgeGroup2)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata_nopt)
leginopt_tsibble$nb[is.na(leginopt_tsibble$nb)] <- 0
g <- leginopt_tsibble %>% as_tibble() %>% summarise(sum(nb))

## without clusters
leginoc_tsibble <- agg_legidata_noc %>%
  as_tsibble(index=week) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata_noc)
leginoc_tsibble$nb[is.na(leginoc_tsibble$nb)] <- 0

## only clusters
legic_tsibble <- agg_legidata_c %>%
  as_tsibble(index=week) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata_c)
legic_tsibble$nb[is.na(legic_tsibble$nb)] <- 0

## with Germany
legide_tsibble <- agg_legidata_de %>%
  as_tsibble(index=week) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata_de)
legide_tsibble$nb[is.na(legide_tsibble$nb)] <- 0

## monthly data
legi_monthly <- agg_monthly %>% 
    as_tsibble(index=month, 
             key=c(CountryName, Imported3, Gender, AgeGroup2)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 Jan"~"2019 Dec")
rm(agg_monthly)
legi_monthly$nb[is.na(legi_monthly$nb)] <- 0

## new age group
legi_newage <- agg_newage %>% 
    as_tsibble(index=week, 
             key=c(Imported3, AgeGroup3)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_newage)
legi_newage$nb[is.na(legi_newage$nb)] <- 0

## labels
x_month <- list(title = "Month")
x_year <- list(title = "Year")
x_week <- list(title = "Week")
y_cases <- list(title = "Cases")
#y_cases <- list(title = "Cases",font=list(size=1))

## create vectors of stratifications
countries <- as.factor(unique(legi_tsibble$CountryName)[!is.na(unique(legi_tsibble$CountryName))])
imported <- as.factor(unique(legi_tsibble$Imported3)[!is.na(unique(legi_tsibble$Imported3))])
agearoups <- as.factor(unique(legi_tsibble$AgeGroup2)[!is.na(unique(legi_tsibble$AgeGroup2)) &
                                                       unique(legi_tsibble$AgeGroup2)!="Unknown"])
genders <- unique(legi_tsibble$Gender)[!is.na(unique(legi_tsibble$Gender)) &
                                         unique(legi_tsibble$Gender)!="UNK"]
```


# {.tabset}
$~$

## Heat map

```{r heatmap,results="asis"}
europe_heat <- legi_tsibble %>% summarise(cases=sum(nb)) %>% as_tibble() %>%  
  mutate(year=year(week), year=as.character(year), year=reorder(year, desc(year)),
         week=as.character(week), week=substring(week,7))
p <- europe_heat %>% ggplot(aes(week, year, fill=cases)) +
  geom_tile(colour="white") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  scale_fill_gradient2(low=rgb(241, 214, 118,maxColorValue = 255), mid=rgb(204, 107, 33,maxColorValue = 255), 
                       high=rgb(124, 23, 15,maxColorValue = 255), na.value="transparent", midpoint=250) +
  xlab(NULL) + ylab(NULL) + ggtitle("Heat map of weekly LD cases by date of onset")
ggplotly(p)
```


## 2017-2019 retrospective prediction {.tabset}

### Europe {.tabset}
#### All cases

```{r europe tsibble, results="asis"}
## Europe tsibble
europe <- legi_tsibble %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,1)+PDQ(0,0,0)))

## create forecast
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```




#### Imported

```{r Imported tsibble, results="asis"}
## Imported tsibble
europe <- legi_tsibble %>%
  filter(Imported3=="Imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=7)+0+pdq(0,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)



analysis_fun(forecast_europe, model_europe)

```


#### Not imported

```{r not imported tsibble, results="asis"}
## unknown tsibble
europe <- legi_tsibble %>%
  filter(Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)



analysis_fun(forecast_europe, model_europe)


```





#### <40

```{r age_40 tsibble, results="asis"}
## age_40 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(0,0,0)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)


analysis_fun(forecast_europe, model_europe)

```


#### 40-49

```{r age_40_49 tsibble,results="asis"}
## age_40_49 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=4)+1+pdq(1,0,0)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)



analysis_fun(forecast_europe, model_europe)


```


#### 50-59

```{r age_50_59 tsibble,results="asis"}
## age_50_59 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,3)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)



analysis_fun(forecast_europe, model_europe)


```


#### 60-69

```{r age_60_69 tsibble,results="asis"}
## age_60_69 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)





analysis_fun(forecast_europe, model_europe)


```


#### 70-79

```{r age_70_79 tsibble,results="asis"}
## age_70_79 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(0,1,2)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)





analysis_fun(forecast_europe, model_europe)

```



#### 80>=

```{r age_80 tsibble,results="asis"}
## age_80 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(0,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)





analysis_fun(forecast_europe, model_europe)


```


#### Male

```{r male tsibble,results="asis"}
## male tsibble
europe <- legi_tsibble %>%
  filter(Gender=="M") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=4)+1+pdq(0,1,3)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)





analysis_fun(forecast_europe, model_europe)


```



#### Female

```{r female tsibble,results="asis"}
## female tsibble
europe <- legi_tsibble %>%
  filter(Gender=="F") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(0,1,2)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)





analysis_fun(forecast_europe, model_europe)


```




## Interrupted time series {.tabset}
### All cases
```{r its analysis,results="asis"}
## Europe tsibble
europe <- legi_tsibble %>%
  summarise(cases=sum(nb))
## Europe 2017-19 tsibble
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

its_fun(europe)
ggplotly(p)




its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```



### Imported 

```{r its Imported,results="asis"}
## Imported tsibble
Imported <- legi_tsibble %>%
  filter(Imported3=="Imported") %>%
  summarise(cases=sum(nb))
## Imported 2018 tsibble
Imported2018 <- Imported %>%
  filter_index("2017 W01"~.)

its_fun(Imported)
ggplotly(p)





its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```



### Not imported
```{r its Not imported,results="asis"}
## unknown tsibble
unknown <- legi_tsibble %>%
  filter(Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
## unknown 2018 tsibble
unknown2018 <- unknown %>%
  filter_index("2017 W01"~.)

its_fun(unknown)
ggplotly(p)





its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```


### <40
```{r its age40,results="asis"}
## age40 tsibble
age40 <- legi_tsibble %>%
  filter(AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
## age40 2018 tsibble
age402018 <- age40 %>%
  filter_index("2017 W01"~.)

its_fun(age40)
ggplotly(p)




its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### 40-49
```{r its age4049,results="asis"}
## age4049 tsibble
age4049 <- legi_tsibble %>%
  filter(AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
## age4049 2018 tsibble
age40492018 <- age4049 %>%
  filter_index("2017 W01"~.)

its_fun(age4049)
ggplotly(p)





its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)

```

### 50-59
```{r its age5059,results="asis"}
## age5059 tsibble
age5059 <- legi_tsibble %>%
  filter(AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
## age5059 2018 tsibble
age50592018 <- age5059 %>%
  filter_index("2017 W01"~.)

its_fun(age5059)
ggplotly(p)



its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### 60-69
```{r its age6069,results="asis"}
## age6069 tsibble
age6069 <- legi_tsibble %>%
  filter(AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
## age6069 2018 tsibble
age60692018 <- age6069 %>%
  filter_index("2017 W01"~.)

its_fun(age6069)
ggplotly(p)




its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### 70-79
```{r its age7079,results="asis"}
## age7079 tsibble
age7079 <- legi_tsibble %>%
  filter(AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
## age7079 2018 tsibble
age70792018 <- age7079 %>%
  filter_index("2017 W01"~.)

its_fun(age7079)
ggplotly(p)



its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### 80>=
```{r its age80,results="asis"}
## age80 tsibble
age80 <- legi_tsibble %>%
  filter(AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
## age80 2018 tsibble
age802018 <- age80 %>%
  filter_index("2017 W01"~.)

its_fun(age80)
ggplotly(p)




its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### Male
```{r its male,results="asis"}
## male tsibble
male <- legi_tsibble %>%
  filter(Gender=="M") %>%
  summarise(cases=sum(nb))
## male 2018 tsibble
male2018 <- male %>%
  filter_index("2017 W01"~.)

its_fun(male)
ggplotly(p)




its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)

```

### Female
```{r its female,results="asis"}
## female tsibble
female <- legi_tsibble %>%
  filter(Gender=="F") %>%
  summarise(cases=sum(nb))
## female 2018 tsibble
female2018 <- female %>%
  filter_index("2017 W01"~.)

its_fun(female)
ggplotly(p)





its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)

```
