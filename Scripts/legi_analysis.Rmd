---
title: "Legionnaires' disease 2012-2019"
output:
  html_document:
  html_notebook:
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 10, fig.height = 5,
  echo=FALSE, warning=FALSE, message=FALSE)

##################### Settings ##################
rm(list=ls())

## load packages
library(tidyverse)
library(fpp3)
library(knitr)
library(kableExtra)
library(DT)
library(plotly)
library(forecast)
library(janitor)

## setting working directory   
PATH="C:/R/legi_analysis"

setwd(PATH)  

## open functions
source("Scripts/legi_functions.R")



######################### prepare the data ############################

## read in legi data and create aggregated data
legidata <- read_csv("Data/legi_agg_onset_4.csv",
                     col_type = list(col_character(), col_date(), col_date(), col_date(), 
                                     col_character(), col_double(), col_character(), col_character(), 
                                     col_character(), col_character(), col_character(),
                                     col_character(), col_character(), col_character(), 
                                     col_character(), col_character(), col_double()))

## create date variable
legidata <- legidata %>%
   mutate(date=case_when(is.na(DateOfOnsetISOdate_date)~DateUsedForStatisticsISO,
                                            TRUE~DateOfOnsetISOdate_date),
          date=case_when(is.na(date)~DateOfNotificationISOdate,
                         TRUE~date))

 completeness_dates <- legidata

## create Imported3
legidata <- legidata %>% 
  mutate(Imported3=case_when(Imported2=="UNK"~Imported,
                             TRUE~Imported2),
         Imported3=case_when(Imported3=="Y"~"Imported",
                              Imported3=="N"~"Not imported",
                              Imported3=="UNK"~"Unknown",
                              is.na(Imported3)~"Unknown"))

## create age groups
legidata$AgeGroup <- NA
legidata$AgeGroup[legidata$Age<20] <- "<20"
legidata$AgeGroup[legidata$Age>=20 & legidata$Age<30] <- "20-29"
legidata$AgeGroup[legidata$Age>=30 & legidata$Age<40] <- "30-39"
legidata$AgeGroup[legidata$Age>=40 & legidata$Age<50] <- "40-49"
legidata$AgeGroup[legidata$Age>=50 & legidata$Age<60] <- "50-59"
legidata$AgeGroup[legidata$Age>=60 & legidata$Age<70] <- "60-69"
legidata$AgeGroup[legidata$Age>=70 & legidata$Age<80] <- "70-79"
legidata$AgeGroup[legidata$Age>=80] <- "80>="
legidata$AgeGroup[is.na(legidata$Age)] <- "Unknown"

legidata$AgeGroup2 <- NA
legidata$AgeGroup2[legidata$Age<40] <- "<40"
legidata$AgeGroup2[legidata$Age>=40 & legidata$Age<50] <- "40-49"
legidata$AgeGroup2[legidata$Age>=50 & legidata$Age<60] <- "50-59"
legidata$AgeGroup2[legidata$Age>=60 & legidata$Age<70] <- "60-69"
legidata$AgeGroup2[legidata$Age>=70 & legidata$Age<80] <- "70-79"
legidata$AgeGroup2[legidata$Age>=80] <- "80>="
legidata$AgeGroup2[is.na(legidata$Age)] <- "Unknown"

legidata$AgeGroup3 <- NA
legidata$AgeGroup3[legidata$Age<65] <- "<65"
legidata$AgeGroup3[legidata$Age>=65] <- "65>="
legidata$AgeGroup3[is.na(legidata$Age)] <- "Unknown"


## add week and month
legidata$week <- yearweek(legidata$date)
legidata$month <- yearmonth(legidata$date)
legidata$date <- NULL

completeness_setting <- legidata

a <- legidata %>% summarise(sum(nb))

## remove dateless cases
legidata <- legidata[!is.na(legidata$week),]
b <- legidata %>% summarise(sum(nb))

## with all countries
legi_all <- legidata

## keeping Germany
legidata_de <- legidata %>% filter(CountryName!="Croatia" & CountryName!="Iceland" & 
                                   CountryName!="Luxembourg" & CountryName!="Bulgaria")

legidata <- legidata %>% filter(CountryName!="Croatia" & CountryName!="Iceland" & 
                                  CountryName!="Germany" & CountryName!="Luxembourg" & CountryName!="Bulgaria")
c <- legidata %>% summarise(sum(nb))

## count cases in week 45 2014 belonging to PT2014 outbreak
legidata %>% filter(week==yearweek("W45 2014")) %>% 
  group_by(ClusterID) %>% summarise(cases=sum(nb)) %>% 
  mutate(percent=100*cases/sum(cases))

## create data without PT2014 outbreak
legidata_nopt <- legidata[legidata$ClusterID!="206-VFX" | is.na(legidata$ClusterID),] ## is.na to include cases after 2014
d <- legidata_nopt %>% summarise(sum(nb))

## data without cluster cases
legidata_noc <- legidata[legidata$Cluster!="Y",] %>% filter(!is.na(nb))
e <- legidata_noc %>% summarise(sum(nb))

## data with only cluster cases
legidata_c <- legidata[legidata$Cluster=="Y",] %>% filter(!is.na(nb))
legidata_c <- legidata_c[legidata_c$ClusterID!="206-VFX" | is.na(legidata_c$ClusterID),] %>% filter(!is.na(nb))
f <- legidata_c %>% summarise(sum(nb))



## aggregate
agg_legidata <- legidata %>% group_by(CountryName, Imported3, Gender, AgeGroup2, week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legiall <- legi_all %>% group_by(CountryName, week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legidata_nopt <- legidata_nopt %>% group_by(CountryName, Imported3, Gender, AgeGroup2, week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legidata_noc <- legidata_noc %>% group_by(week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legidata_c <- legidata_c %>% group_by(week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_legidata_de <- legidata_de %>% group_by(week) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_monthly <- legidata %>% group_by(CountryName, Imported3, Gender, AgeGroup2, month) %>%
  summarise(nb=sum(nb)) %>% ungroup()

agg_newage <- legidata_nopt %>% group_by(Imported3, AgeGroup3, week) %>%
  summarise(nb=sum(nb)) %>% ungroup()



################################################## create Legi tsibbles ###############################################
legi_tsibble <- agg_legidata %>%
  as_tsibble(index=week, 
             key=c(CountryName, Imported3, Gender, AgeGroup2)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata) ## remove aggregated data
legi_tsibble$nb[is.na(legi_tsibble$nb)] <- 0 ## fill missing weeks with 0 cases

legi_alltsibble <- agg_legiall %>%
  as_tsibble(index=week, 
             key=c(CountryName)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legiall)
legi_alltsibble$nb[is.na(legi_alltsibble$nb)] <- 0

## without PT outbreak
leginopt_tsibble <- agg_legidata_nopt %>%
  as_tsibble(index=week, 
             key=c(CountryName, Imported3, Gender, AgeGroup2)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata_nopt)
leginopt_tsibble$nb[is.na(leginopt_tsibble$nb)] <- 0
g <- leginopt_tsibble %>% as_tibble() %>% summarise(sum(nb))

## without clusters
leginoc_tsibble <- agg_legidata_noc %>%
  as_tsibble(index=week) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata_noc)
leginoc_tsibble$nb[is.na(leginoc_tsibble$nb)] <- 0

## only clusters
legic_tsibble <- agg_legidata_c %>%
  as_tsibble(index=week) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata_c)
legic_tsibble$nb[is.na(legic_tsibble$nb)] <- 0

## with Germany
legide_tsibble <- agg_legidata_de %>%
  as_tsibble(index=week) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_legidata_de)
legide_tsibble$nb[is.na(legide_tsibble$nb)] <- 0

## monthly data
legi_monthly <- agg_monthly %>% 
    as_tsibble(index=month, 
             key=c(CountryName, Imported3, Gender, AgeGroup2)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 Jan"~"2019 Dec")
rm(agg_monthly)
legi_monthly$nb[is.na(legi_monthly$nb)] <- 0

## new age group
legi_newage <- agg_newage %>% 
    as_tsibble(index=week, 
             key=c(Imported3, AgeGroup3)) %>%
  fill_gaps(.full=TRUE) %>%
  filter_index("2012 W01"~"2019 W52")
rm(agg_newage)
legi_newage$nb[is.na(legi_newage$nb)] <- 0

## labels
x_month <- list(title = "Month")
x_year <- list(title = "Year")
x_week <- list(title = "Week")
y_cases <- list(title = "Cases")
#y_cases <- list(title = "Cases",font=list(size=1))

## create vectors of stratifications
countries <- as.factor(unique(legi_tsibble$CountryName)[!is.na(unique(legi_tsibble$CountryName))])
imported <- as.factor(unique(legi_tsibble$Imported3)[!is.na(unique(legi_tsibble$Imported3))])
agearoups <- as.factor(unique(legi_tsibble$AgeGroup2)[!is.na(unique(legi_tsibble$AgeGroup2)) &
                                                       unique(legi_tsibble$AgeGroup2)!="Unknown"])
genders <- unique(legi_tsibble$Gender)[!is.na(unique(legi_tsibble$Gender)) &
                                         unique(legi_tsibble$Gender)!="UNK"]
```


# {.tabset}
$~$

## Part 1: Summary statistics {.tabset}

### All cases
```{r all cases tables,results="asis"}
aggregate(nb~year(week), sum, data=legi_tsibble) %>%
  mutate(year=`year(week)`) %>% select(year,nb) %>% 
  pivot_wider(names_from=year,values_from=nb) %>% 
  mutate(total=`2012`+`2013`+`2014`+`2015`+`2016`+`2017`+`2018`+`2019`) %>%
  kable(col.names=c("2012", "2013", "2014", "2015", "2016", "2017",
                         "2018", "2019", "All years"),
            caption="Cases per year") %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"))

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

# median, IQR, & median age
median_total <- legi_tsibble %>% summarise(cases=sum(nb)) %>% as_tibble() %>% 
  summarise_at(vars(cases),
               list(min=min, Q1=~quantile(., probs = 0.25),
                    median=median, Q3=~quantile(., probs = 0.75),
                    max=max)) %>% select(Q1,median,Q3) %>% 
  t() %>% as_tibble() %>% rename(Total=V1)

legi_tsibble %>% summarise(cases=sum(nb)) %>% as_tibble() %>% 
   mutate(year=year(week)) %>% group_by(year) %>%
  summarise_at(vars(cases),
               list(min=min, Q1=~quantile(., probs = 0.25),
                    median=median, Q3=~quantile(., probs = 0.75),
                    max=max)) %>% select(year,Q1,median,Q3) %>% 
  t() %>% row_to_names(row_number=1) %>% as_tibble() %>% 
  cbind(median_total) %>% mutate(Measure=c("Q1","Median","Q3")) %>% 
  select(Measure,1:9) %>% 
  kable(col.names=c("Measure", "2012", "2013", "2014", "2015", "2016", "2017",
                         "2018", "2019", "All years"),
            caption="Median and IQR of weekly cases") %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"))

## median age
df <- legidata %>% mutate(year=year(week)) %>% select(year,Age,nb) %>%
  filter(year>=2012 & year<=2019) %>% filter(!is.na(Age)) %>%  as.data.frame()
df <- df[rep(1:nrow(df), df[,3]),-3]

df %>% group_by(year) %>% summarise(median = median(Age, na.rm = TRUE)) %>% 
  rbind(c("Total",median(df$Age))) %>% pivot_wider(names_from=year,values_from=median) %>% 
    kable(col.names=c("2012", "2013", "2014", "2015", "2016", "2017",
                         "2018", "2019", "All years"),
            caption="Median age per LD case") %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"))

p <- legi_tsibble %>% as_tibble() %>% 
  mutate(Year=as.character(year(week))) %>% group_by(Year, week) %>% 
  summarise(Cases=sum(nb)) %>% 
  ggplot(aes(x=Year, y=Cases)) + geom_boxplot() +
  ggtitle("Box plot of LD cases per year, 2012-2019")
ggplotly(p)
```


### By country
```{r country tables,results="asis"}
## per country and year
aggregate(nb~CountryName+year(week), sum, data=legi_tsibble) %>%
  reshape(idvar="CountryName",timevar="year(week)",direction="wide") %>% 
  mutate(total=nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019) %>%
  arrange(desc(total)) %>% select(-CountryName) %>% 
  datatable(colnames = c("Country", "2012", "2013", "2014", "2015", "2016", "2017",
                         "2018", "2019", "All years"),
            caption="Cases per country and year",
            rownames=c("Italy","France","Spain","Netherlands","United Kingdom","Portugal",
                       "Czechia","Austria","Denmark","Sweden", "Slovenia", "Belgium",
                       "Hungary","Norway","Greece","Latvia","Poland","Slovakia","Ireland","Romania",
                       "Estonia","Lithuania","Finland","Cyprus","Malta")) %>% 
  formatRound(columns=c("nb.2012", "nb.2013", "nb.2014", "nb.2015", "nb.2016", 
                        "nb.2017", "nb.2018", "nb.2019", "total"), 
              digits=c(0,0,0,0,0,0,0,0,0))



## % per country and year
aggregate(nb~CountryName+year(week), sum, data=legi_tsibble) %>%
  reshape(idvar="CountryName",timevar="year(week)",direction="wide") %>% 
  mutate(percent=((nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019)/sum(legi_tsibble$nb))*100,
         percent_2012=(nb.2012/sum(nb.2012))*100,
         percent_2013=(nb.2013/sum(nb.2013))*100,
         percent_2014=(nb.2014/sum(nb.2014))*100,
         percent_2015=(nb.2015/sum(nb.2015))*100,
         percent_2016=(nb.2016/sum(nb.2016))*100,
         percent_2017=(nb.2017/sum(nb.2017))*100,
         percent_2018=(nb.2018/sum(nb.2018))*100,
         percent_2019=(nb.2019/sum(nb.2019))*100) %>%
  select(percent_2012, percent_2013, percent_2014, percent_2015, percent_2016, percent_2017,
         percent_2018, percent_2019, percent) %>% 
  arrange(desc(percent)) %>%
  datatable(colnames = c("Country", "2012 (%)", "2013 (%)", "2014 (%)", "2015 (%)", "2016 (%)", "2017 (%)",
                         "2018 (%)", "2019 (%)","All years (%)"),
            caption="Percentage of cases per country and year",
            rownames=c("Italy","France","Spain","Netherlands","United Kingdom","Portugal",
                       "Czechia","Denmark","Sweden", "Austria","Slovenia", "Belgium",
                       "Hungary","Norway","Greece","Latvia","Poland","Slovakia","Ireland","Romania",
                       "Estonia","Lithuania","Finland","Cyprus","Malta")) %>% 
  formatRound(columns=c("percent_2012", "percent_2013","percent_2014", "percent_2015", "percent_2016", 
                        "percent_2017", "percent_2018", "percent_2019", "percent"), 
              digits=c(1,1,1,1,1,1,1,1,1))

## all countries 
## % per country and year
legi_alltsibble %>% mutate(new_country=case_when(
  CountryName=="Croatia" | CountryName=="Iceland" | 
  CountryName=="Germany" | CountryName=="Luxembourg" | CountryName=="Bulgaria" ~ "Removed",
  TRUE ~ "Remaining"),
  year=year(week)) %>% as_tibble() %>% group_by(new_country,year) %>% summarise(cases=sum(nb)) %>% 
  pivot_wider(names_from=year,values_from=cases) %>% ungroup() %>% 
  mutate(percent=((`2012`+`2013`+`2014`+`2015`+`2016`+`2017`+`2018`+`2019`)/sum(legi_alltsibble$nb))*100,
         percent_2012=(`2012`/sum(`2012`))*100,
         percent_2013=(`2013`/sum(`2013`))*100,
         percent_2014=(`2014`/sum(`2014`))*100,
         percent_2015=(`2015`/sum(`2015`))*100,
         percent_2016=(`2016`/sum(`2016`))*100,
         percent_2017=(`2017`/sum(`2017`))*100,
         percent_2018=(`2018`/sum(`2018`))*100,
         percent_2019=(`2019`/sum(`2019`))*100) %>%
  select(new_country, percent_2012, percent_2013, percent_2014, percent_2015, percent_2016, percent_2017,
         percent_2018, percent_2019, percent) %>% 
  arrange(desc(percent)) %>%
  datatable(colnames = c("Country", "2012 (%)", "2013 (%)", "2014 (%)", "2015 (%)", "2016 (%)", "2017 (%)",
                         "2018 (%)", "2019 (%)","All years (%)"),
            caption="Percentage of cases for countries remaining and removed from analysis",
            rownames=c("Remaining","Removed")) %>% 
  formatRound(columns=c("percent_2012", "percent_2013","percent_2014", "percent_2015", "percent_2016", 
                        "percent_2017", "percent_2018", "percent_2019", "percent"), 
              digits=c(1,1,1,1,1,1,1,1,1))
```

$~$

### By Imported
```{r Imported3 tables,results="asis"}
## per Imported3 and year
aggregate(nb~Imported3+year(week), sum, data=legi_tsibble) %>%
  reshape(idvar="Imported3",timevar="year(week)",direction="wide") %>% 
  mutate(total=nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019) %>%
  arrange(desc(total)) %>% select(-Imported3) %>% 
  datatable(colnames = c("Imported3", "2012", "2013", "2014", "2015", "2016", "2017",
                         "2018", "2019", "All years"),
            caption="Cases per imported and year",
            rownames=c("Not imported", "Imported", "Unknown")) %>% 
  formatRound(columns=c("nb.2012", "nb.2013", "nb.2014", "nb.2015", "nb.2016", 
                        "nb.2017", "nb.2018", "nb.2019", "total"), 
              digits=c(0,0,0,0,0,0,0,0,0))



## % per Imported3 and year
aggregate(nb~Imported3+year(week), sum, data=legi_tsibble) %>%
  reshape(idvar="Imported3",timevar="year(week)",direction="wide") %>% 
  mutate(percent=((nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019)/sum(legi_tsibble$nb))*100,
         percent_2012=(nb.2012/sum(nb.2012))*100,
         percent_2013=(nb.2013/sum(nb.2013))*100,
         percent_2014=(nb.2014/sum(nb.2014))*100,
         percent_2015=(nb.2015/sum(nb.2015))*100,
         percent_2016=(nb.2016/sum(nb.2016))*100,
         percent_2017=(nb.2017/sum(nb.2017))*100,
         percent_2018=(nb.2018/sum(nb.2018))*100,
         percent_2019=(nb.2019/sum(nb.2019))*100) %>%
  select(percent_2012, percent_2013, percent_2014, percent_2015, percent_2016, percent_2017,
         percent_2018, percent_2019, percent) %>% 
  arrange(desc(percent)) %>%
  datatable(colnames = c("Imported3", "2012 (%)", "2013 (%)", "2014 (%)", "2015 (%)", "2016 (%)", "2017 (%)",
                         "2018 (%)", "2019 (%)","All years (%)"),
            caption="Percentage of cases per Imported and year",
            rownames=c("Not imported", "Imported", "Unknown")) %>% 
  formatRound(columns=c("percent_2012", "percent_2013","percent_2014", "percent_2015", "percent_2016", 
                        "percent_2017", "percent_2018", "percent_2019", "percent"), 
              digits=c(1,1,1,1,1,1,1,1,1))

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))
```
$~$

### By age group
```{r age group tables,results="asis"}
## per age group and year
aggregate(nb~AgeGroup2+year(week), sum, data=legi_tsibble) %>%
  reshape(idvar="AgeGroup2",timevar="year(week)",direction="wide") %>% 
  mutate(total=nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019) %>%
  select(-AgeGroup2) %>% 
  datatable(colnames = c("Age Group", "2012", "2013", "2014", "2015", "2016", "2017",
                         "2018", "2019", "All years"),
            caption="Cases per Age Group and year",
            rownames=c("<40", "40-49", "50-59", "60-69", 
                       "70-79", "80>=", "Unknown")) %>% 
  formatRound(columns=c("nb.2012", "nb.2013", "nb.2014", "nb.2015", "nb.2016", 
                        "nb.2017", "nb.2018", "nb.2019", "total"), 
              digits=c(0,0,0,0,0,0,0,0,0))



## % per age group and year
aggregate(nb~AgeGroup2+year(week), sum, data=legi_tsibble) %>%
  reshape(idvar="AgeGroup2",timevar="year(week)",direction="wide") %>% 
  mutate(percent=((nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019)/sum(legi_tsibble$nb))*100,
         percent_2012=(nb.2012/sum(nb.2012))*100,
         percent_2013=(nb.2013/sum(nb.2013))*100,
         percent_2014=(nb.2014/sum(nb.2014))*100,
         percent_2015=(nb.2015/sum(nb.2015))*100,
         percent_2016=(nb.2016/sum(nb.2016))*100,
         percent_2017=(nb.2017/sum(nb.2017))*100,
         percent_2018=(nb.2018/sum(nb.2018))*100,
         percent_2019=(nb.2019/sum(nb.2019))*100) %>%
  select(percent_2012, percent_2013, percent_2014, percent_2015, percent_2016, percent_2017,
         percent_2018, percent_2019, percent) %>% 
  datatable(colnames = c("Age Group", "2012 (%)", "2013 (%)", "2014 (%)", "2015 (%)", "2016 (%)", "2017 (%)",
                         "2018 (%)", "2019 (%)","All years (%)"),
            caption="Percentage of cases per Age Group and year",
            rownames=c("<40", "40-49", "50-59", "60-69", 
                       "70-79", "80>=", "Unknown")) %>% 
  formatRound(columns=c("percent_2012", "percent_2013","percent_2014", "percent_2015", "percent_2016", 
                        "percent_2017", "percent_2018", "percent_2019", "percent"), 
              digits=c(1,1,1,1,1,1,1,1,1))



## per new age group
aggregate(nb~AgeGroup3+year(week), sum, data=legi_newage) %>%
  reshape(idvar="AgeGroup3",timevar="year(week)",direction="wide") %>% 
  mutate(total=nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019) %>%
  datatable(colnames = c("Age Group", "2012", "2013", "2014", "2015", "2016", "2017",
                         "2018", "2019", "All years"),
            caption="Cases per Age Group and year") %>% 
  formatRound(columns=c("nb.2012", "nb.2013", "nb.2014", "nb.2015", "nb.2016", 
                        "nb.2017", "nb.2018", "nb.2019", "total"), 
              digits=c(0,0,0,0,0,0,0,0,0))



## % per new age group
aggregate(nb~AgeGroup3+year(week), sum, data=legi_newage) %>%
  reshape(idvar="AgeGroup3",timevar="year(week)",direction="wide") %>% 
  mutate(percent=((nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019)/sum(legi_tsibble$nb))*100,
         percent_2012=(nb.2012/sum(nb.2012))*100,
         percent_2013=(nb.2013/sum(nb.2013))*100,
         percent_2014=(nb.2014/sum(nb.2014))*100,
         percent_2015=(nb.2015/sum(nb.2015))*100,
         percent_2016=(nb.2016/sum(nb.2016))*100,
         percent_2017=(nb.2017/sum(nb.2017))*100,
         percent_2018=(nb.2018/sum(nb.2018))*100,
         percent_2019=(nb.2019/sum(nb.2019))*100) %>%
  select(AgeGroup3, percent_2012, percent_2013, percent_2014, percent_2015, percent_2016, percent_2017,
         percent_2018, percent_2019, percent) %>% 
  datatable(colnames = c("Age Group", "2012 (%)", "2013 (%)", "2014 (%)", "2015 (%)", "2016 (%)", "2017 (%)",
                         "2018 (%)", "2019 (%)","All years (%)"),
            caption="Percentage of cases per Age Group and year") %>% 
  formatRound(columns=c("percent_2012", "percent_2013","percent_2014", "percent_2015", "percent_2016", 
                        "percent_2017", "percent_2018", "percent_2019", "percent"), 
              digits=c(1,1,1,1,1,1,1,1,1))

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))
```
$~$

### By gender
```{r gender tables,results="asis"}
## per Gender and year
aggregate(nb~Gender+year(week), sum, data=legi_tsibble) %>%
  reshape(idvar="Gender",timevar="year(week)",direction="wide") %>% 
  mutate(total=nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019) %>%
  arrange(desc(total)) %>% select(-Gender) %>% 
  datatable(colnames = c("Gender", "2012", "2013", "2014", "2015", "2016", "2017",
                         "2018", "2019", "All years"),
            caption="Cases per Gender and year",
            rownames=c("Male", "Female", "Unknown")) %>% 
  formatRound(columns=c("nb.2012", "nb.2013", "nb.2014", "nb.2015", "nb.2016", 
                        "nb.2017", "nb.2018", "nb.2019", "total"), 
              digits=c(0,0,0,0,0,0,0,0,0))



## % per Gender and year
aggregate(nb~Gender+year(week), sum, data=legi_tsibble) %>%
  reshape(idvar="Gender",timevar="year(week)",direction="wide") %>% 
  mutate(percent=((nb.2012+nb.2013+nb.2014+nb.2015+nb.2016+nb.2017+nb.2018+nb.2019)/sum(legi_tsibble$nb))*100,
         percent_2012=(nb.2012/sum(nb.2012))*100,
         percent_2013=(nb.2013/sum(nb.2013))*100,
         percent_2014=(nb.2014/sum(nb.2014))*100,
         percent_2015=(nb.2015/sum(nb.2015))*100,
         percent_2016=(nb.2016/sum(nb.2016))*100,
         percent_2017=(nb.2017/sum(nb.2017))*100,
         percent_2018=(nb.2018/sum(nb.2018))*100,
         percent_2019=(nb.2019/sum(nb.2019))*100) %>%
  select(percent_2012, percent_2013, percent_2014, percent_2015, percent_2016, percent_2017,
         percent_2018, percent_2019, percent) %>% 
  arrange(desc(percent)) %>%
  datatable(colnames = c("Gender", "2012 (%)", "2013 (%)", "2014 (%)", "2015 (%)", "2016 (%)", "2017 (%)",
                         "2018 (%)", "2019 (%)","All years (%)"),
            caption="Percentage of cases per Gender and year",
            rownames=c("Male", "Female", "Unknown")) %>% 
  formatRound(columns=c("percent_2012", "percent_2013","percent_2014", "percent_2015", "percent_2016", 
                        "percent_2017", "percent_2018", "percent_2019", "percent"), 
              digits=c(1,1,1,1,1,1,1,1,1))

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))
```
$~$

### Completeness tables {.tabset}

#### Dates
```{r completeness tables,results="asis"}
 countries <- unique(completeness_dates$CountryName) %>% as_tibble() %>% rename(CountryName=value)

 missing_onset <- completeness_dates %>% group_by(CountryName) %>% count(DateOfOnsetISOdate_date,sort=TRUE) %>%
   mutate(missing_onset=100*n/sum(n)) %>% filter(is.na(DateOfOnsetISOdate_date)) %>%
   select(CountryName,missing_onset)

 missing_notification <- completeness_dates %>% group_by(CountryName) %>% count(DateOfNotificationISOdate,sort=TRUE) %>%
   mutate(missing_notification=100*n/sum(n)) %>% filter(is.na(DateOfNotificationISOdate)) %>%
   select(CountryName,missing_notification)

 missing_statistics <- completeness_dates %>% group_by(CountryName) %>% count(DateUsedForStatisticsISO,sort=TRUE) %>%
   mutate(missing_statistics=100*n/sum(n)) %>% filter(is.na(DateUsedForStatisticsISO)) %>%
   select(CountryName,missing_statistics)

 missing_newdate <- completeness_dates %>% group_by(CountryName) %>% count(date,sort=TRUE) %>%
   mutate(missing_newdate=100*n/sum(n)) %>% filter(is.na(date)) %>%
   select(CountryName,missing_newdate)

 left_join(countries,missing_onset,by=c("CountryName")) %>%
   left_join(missing_notification,by=c("CountryName")) %>%
   left_join(missing_statistics,by=c("CountryName")) %>%
   left_join(missing_newdate,by=c("CountryName")) %>%
   mutate_all(~replace(., is.na(.), 0)) %>%
   mutate_at(vars(-CountryName),funs(round(.,digits=1))) %>% 
       kable("html", align="c", caption="Completeness of date variables",
          col.names=c("Country","% missing date of onset", "% missing date of notification",
                      "% mising date used for statistics", "% missing new date variable")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
 
 
```


#### Imported
```{r completeness imported,results="asis"}
options(knitr.kable.NA = '')
completeness_setting <- completeness_setting %>% mutate(year=year(week))
completeness_setting %>% 
  select(CountryName,year,Imported,nb) %>% 
  filter(year>=2012 & year<=2019) %>% 
  mutate(Imported=case_when(Imported=="UNK" | is.na(Imported)~"UNK",
                             TRUE~"Completeness"),
         year=case_when(year>=2012 & year<=2016~"n2012_2016",
                        year>=2017 & year<=2019~"n2017_2019")) %>% 
  group_by(CountryName,year,Imported) %>% summarise(nb=sum(nb)) %>% 
  pivot_wider(names_from=year,values_from=nb) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(percent_2012_2016=round(100*n2012_2016/sum(n2012_2016),digits=1),
         percent_2017_2019=round(100*n2017_2019/sum(n2017_2019),digits=1),
         n_all=n2012_2016+n2017_2019,
         percent_all=round(100*n_all/sum(n_all),digits=1)) %>% 
  filter(Imported=="Completeness") %>% 
  select(CountryName,n2012_2016,percent_2012_2016,n2017_2019,percent_2017_2019,n_all,percent_all) %>% 
    kable("html", align="c", caption="Completeness of Imported",
          col.names=c("Country", "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)")) %>%
    kable_styling(bootstrap_options = c("striped", "hover")) %>%
    add_header_above(c(" "=1, "2012-2016"=2, "2017-2019"=2, "2012-2019"=2))
```


#### Imported2
```{r completeness imported2,results="asis"}
options(knitr.kable.NA = '')
completeness_setting %>% 
  select(CountryName,year,Imported2,nb) %>% 
  filter(year>=2012 & year<=2019) %>% 
  mutate(Imported2=case_when(Imported2=="UNK" | is.na(Imported2)~"UNK",
                             TRUE~"Completeness"),
         year=case_when(year>=2012 & year<=2016~"n2012_2016",
                        year>=2017 & year<=2019~"n2017_2019")) %>% 
  group_by(CountryName,year,Imported2) %>% summarise(nb=sum(nb)) %>% 
  pivot_wider(names_from=year,values_from=nb) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(percent_2012_2016=round(100*n2012_2016/sum(n2012_2016),digits=1),
         percent_2017_2019=round(100*n2017_2019/sum(n2017_2019),digits=1),
         n_all=n2012_2016+n2017_2019,
         percent_all=round(100*n_all/sum(n_all),digits=1)) %>% 
  filter(Imported2=="Completeness") %>% 
  select(CountryName,n2012_2016,percent_2012_2016,n2017_2019,percent_2017_2019,n_all,percent_all) %>% 
    kable("html", align="c", caption="Completeness of Imported2",
          col.names=c("Country", "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)")) %>%
    kable_styling(bootstrap_options = c("striped", "hover")) %>%
    add_header_above(c(" "=1, "2012-2016"=2, "2017-2019"=2, "2012-2019"=2))
```

#### Setting
```{r completeness setting,results="asis"}
options(knitr.kable.NA = '')
completeness_setting %>% 
  select(CountryName,year,Setting,nb) %>% 
  filter(year>=2012 & year<=2019) %>% 
  mutate(Setting=case_when(Setting=="UNK" | is.na(Setting)~"UNK",
                             TRUE~"Completeness"),
         year=case_when(year>=2012 & year<=2016~"n2012_2016",
                        year>=2017 & year<=2019~"n2017_2019")) %>% 
  group_by(CountryName,year,Setting) %>% summarise(nb=sum(nb)) %>% 
  pivot_wider(names_from=year,values_from=nb) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(percent_2012_2016=round(100*n2012_2016/sum(n2012_2016),digits=1),
         percent_2017_2019=round(100*n2017_2019/sum(n2017_2019),digits=1),
         n_all=n2012_2016+n2017_2019,
         percent_all=round(100*n_all/sum(n_all),digits=1)) %>% 
  filter(Setting=="Completeness") %>% 
  select(CountryName,n2012_2016,percent_2012_2016,n2017_2019,percent_2017_2019,n_all,percent_all) %>% 
    kable("html", align="c", caption="Completeness of Setting",
          col.names=c("Country", "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)")) %>%
    kable_styling(bootstrap_options = c("striped", "hover")) %>%
    add_header_above(c(" "=1, "2012-2016"=2, "2017-2019"=2, "2012-2019"=2))
```

#### Setting2
```{r completeness setting2,results="asis"}
options(knitr.kable.NA = '')
completeness_setting %>% 
  select(CountryName,year,Setting2,nb) %>% 
  filter(year>=2012 & year<=2019) %>% 
  mutate(Setting2=case_when(Setting2=="UNK" | is.na(Setting2)~"UNK",
                             TRUE~"Completeness"),
         year=case_when(year>=2012 & year<=2016~"n2012_2016",
                        year>=2017 & year<=2019~"n2017_2019")) %>% 
  group_by(CountryName,year,Setting2) %>% summarise(nb=sum(nb)) %>% 
  pivot_wider(names_from=year,values_from=nb) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(percent_2012_2016=round(100*n2012_2016/sum(n2012_2016),digits=1),
         percent_2017_2019=round(100*n2017_2019/sum(n2017_2019),digits=1),
         n_all=n2012_2016+n2017_2019,
         percent_all=round(100*n_all/sum(n_all),digits=1)) %>% 
  filter(Setting2=="Completeness") %>% 
  select(CountryName,n2012_2016,percent_2012_2016,n2017_2019,percent_2017_2019,n_all,percent_all) %>% 
    kable("html", align="c", caption="Completeness of Setting2",
          col.names=c("Country", "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)")) %>%
    kable_styling(bootstrap_options = c("striped", "hover")) %>%
    add_header_above(c(" "=1, "2012-2016"=2, "2017-2019"=2, "2012-2019"=2))
```

#### New variable
```{r completeness imported3,results="asis"}
options(knitr.kable.NA = '')
completeness_setting %>% 
  select(CountryName,year,Imported3,nb) %>% 
  filter(year>=2012 & year<=2019) %>% 
  mutate(Imported3=case_when(Imported3=="Unknown" | is.na(Imported3)~"UNK",
                             TRUE~"Completeness"),
         year=case_when(year>=2012 & year<=2016~"n2012_2016",
                        year>=2017 & year<=2019~"n2017_2019")) %>% 
  group_by(CountryName,year,Imported3) %>% summarise(nb=sum(nb)) %>% 
  pivot_wider(names_from=year,values_from=nb) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(percent_2012_2016=round(100*n2012_2016/sum(n2012_2016),digits=1),
         percent_2017_2019=round(100*n2017_2019/sum(n2017_2019),digits=1),
         n_all=n2012_2016+n2017_2019,
         percent_all=round(100*n_all/sum(n_all),digits=1)) %>% 
  filter(Imported3=="Completeness") %>% 
  select(CountryName,n2012_2016,percent_2012_2016,n2017_2019,percent_2017_2019,n_all,percent_all) %>% 
    kable("html", align="c", caption="Completeness of Imported",
          col.names=c("Country", "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)",
                      "Cases without UNK (n)", "Reporting completeness (%)")) %>%
    kable_styling(bootstrap_options = c("striped", "hover")) %>%
    add_header_above(c(" "=1, "2012-2016"=2, "2017-2019"=2, "2012-2019"=2))
```

$~$

## Part 2: Seasonality plots {.tabset}

### All cases
```{r seasonality,results="asis"}
p <- legi_tsibble %>% summarise(cases=sum(nb)) %>% gg_season(cases) + ggtitle("Weekly plot: LD cases date of onset") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) + 
  scale_x_yearweek(breaks="4 weeks", date_labels="%W", expand = c(0, 0))
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% summarise(cases=sum(nb)) %>% gg_subseries(cases) + 
  ggtitle("Monthly subseries plot: LD cases by date of onset") +
  scale_x_yearweek(breaks="2 years", date_labels="%Y") + theme(axis.text.x=element_text(angle=90))
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% mutate(year=year(month), month2=format(month, format="%m")) %>% 
  group_by(month2, year) %>% summarise(cases=sum(nb)) %>% 
  ggplot(aes(x=month2, y=cases, group=month2)) + geom_boxplot() +
  scale_x_discrete(labels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  ggtitle("Monthly boxplot: LD cases by date of onset")
ggplotly(p + ylab(NULL) + xlab(NULL))

## heat map
europe_heat <- legi_tsibble %>% summarise(cases=sum(nb)) %>% as_tibble() %>%  
  mutate(year=year(week), year=as.character(year), year=reorder(year, desc(year)),
         week=as.character(week), week=substring(week,7))
p <- europe_heat %>% ggplot(aes(week, year, fill=cases)) +
  geom_tile(colour="white") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  scale_fill_gradient2(low=rgb(241, 214, 118,maxColorValue = 255), mid=rgb(204, 107, 33,maxColorValue = 255), 
                       high=rgb(124, 23, 15,maxColorValue = 255), na.value="transparent", midpoint=250) +
  xlab(NULL) + ylab(NULL) + ggtitle("Heat map of weekly LD cases by date of onset")
ggplotly(p)
```


### By country
```{r seasonality by country,results="asis"}
p <- legi_tsibble %>% group_by(CountryName) %>% summarise(cases=sum(nb)) %>%  
  filter(!is.na(CountryName) & CountryName=="Italy" | CountryName=="France" | CountryName=="Spain" |
           CountryName=="Portugal" | CountryName=="Netherlands" | CountryName=="United Kingdom") %>% 
  gg_season(cases) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) + 
  scale_x_yearweek(breaks="4 weeks", date_labels="%W", expand = c(0, 0)) + 
  ggtitle("Weekly plot by country: LD cases by date of onset")
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% group_by(CountryName) %>% summarise(cases=sum(nb)) %>% 
  filter(!is.na(CountryName) & CountryName=="Italy" | CountryName=="France" | CountryName=="Spain" |
           CountryName=="Portugal" | CountryName=="Netherlands" | CountryName=="United Kingdom") %>%  
  gg_subseries(cases) + ggtitle("Monthly subseries plot by country: LD cases by date of onset") +
  scale_x_yearweek(breaks="2 years", date_labels="%Y") + theme(axis.text.x=element_text(angle=90))
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% mutate(year=year(month), month2=format(month, format="%m")) %>% 
  group_by(month2, year, CountryName) %>% summarise(cases=sum(nb)) %>% 
  filter(!is.na(CountryName) & CountryName=="Italy" | CountryName=="France" | CountryName=="Portugal" |
           CountryName=="Spain" | CountryName=="Netherlands" | CountryName=="United Kingdom") %>% 
  ggplot(aes(x=month2, y=cases, group=month2)) + geom_boxplot() +
  scale_x_discrete(labels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  facet_wrap(~CountryName, scales="fixed") + ggtitle("Monthly boxplot by country: LD cases by date of onset")
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_tsibble %>% filter(CountryName=="Italy" | CountryName=="France" | CountryName=="Spain" |
                             CountryName=="Portugal" | CountryName=="Netherlands" | CountryName=="United Kingdom") %>% 
  group_by(CountryName) %>% summarise(cases=sum(nb)) %>% as_tibble() %>% 
  mutate(year=year(week), year=as.character(year), year=reorder(year, desc(year)),
         week=as.character(week), week=substring(week,7)) %>% group_by(CountryName, week) %>% 
  summarise(cases=sum(cases)) %>% mutate(rel_cases=cases/first(cases)) %>% filter(week!="53") %>% 
  ggplot(aes(x=week, y=rel_cases, group=CountryName,color=CountryName)) + geom_line() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim=c(0, NA)) +
  ggtitle("Weekly LD cases (relative to week 1) by week and country")
ggplotly(p)
```


### By Imported
```{r seasonality by Imported3,results="asis"}
p <- legi_tsibble %>% group_by(Imported3) %>% summarise(cases=sum(nb)) %>%  
  filter(!is.na(Imported3)) %>%  gg_season(cases) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) + 
  scale_x_yearweek(breaks="4 weeks", date_labels="%W", expand = c(0, 0)) +
  ggtitle("Weekly plot by Imported3: LD cases by date of onset")
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% group_by(Imported3) %>% summarise(cases=sum(nb)) %>% 
  filter(!is.na(Imported3)) %>% gg_subseries(cases) + 
  ggtitle("Monthly subseries plot by Imported3: LD cases by date of onset") +
  scale_x_yearweek(breaks="2 years", date_labels="%Y") + theme(axis.text.x=element_text(angle=90))
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% mutate(year=year(month), month2=format(month, format="%m")) %>% 
  group_by(month2, year, Imported3) %>% summarise(cases=sum(nb)) %>% 
  filter(!is.na(Imported3)) %>% 
  ggplot(aes(x=month2, y=cases, group=month2)) + geom_boxplot() +
  scale_x_discrete(labels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  facet_wrap(~Imported3, scales="fixed") + ggtitle("Monthly boxplot by Imported3: LD cases by date of onset")
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_tsibble %>% filter(!is.na(Imported3)) %>% group_by(Imported3) %>% 
  summarise(cases=sum(nb)) %>% as_tibble() %>% 
  mutate(year=year(week), year=as.character(year), year=reorder(year, desc(year)),
         week=as.character(week), week=substring(week,7)) %>% group_by(Imported3, week) %>% 
  summarise(cases=sum(cases)) %>% mutate(rel_cases=cases/first(cases)) %>% filter(week!="53") %>% 
  ggplot(aes(x=week, y=rel_cases, group=Imported3,color=Imported3)) + geom_line() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim=c(0, NA)) +
  ggtitle("Weekly LD cases (relative to week 1) by week and Imported3")
ggplotly(p)
```


### By age group
```{r seasonality by age group,results="asis"}
p <- legi_tsibble %>% group_by(AgeGroup2) %>% summarise(cases=sum(nb)) %>%  
  filter(!is.na(AgeGroup2) & AgeGroup2!="Unknown") %>%  gg_season(cases) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) + 
  scale_x_yearweek(breaks="4 weeks", date_labels="%W", expand = c(0, 0)) +
  ggtitle("Weekly plot by age group: LD cases by date of onset")
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% group_by(AgeGroup2) %>% summarise(cases=sum(nb)) %>% 
  filter(!is.na(AgeGroup2) & AgeGroup2!="Unknown") %>% gg_subseries(cases) + 
  ggtitle("Monthly subseries plot by age group: LD cases by date of onset") +
  scale_x_yearweek(breaks="2 years", date_labels="%Y") + theme(axis.text.x=element_text(angle=90))
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% mutate(year=year(month), month2=format(month, format="%m")) %>% 
  group_by(month2, year, AgeGroup2) %>% summarise(cases=sum(nb)) %>% 
  filter(!is.na(AgeGroup2) & AgeGroup2!="Unknown") %>% 
  ggplot(aes(x=month2, y=cases, group=month2)) + geom_boxplot() +
  scale_x_discrete(labels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  facet_wrap(~AgeGroup2, scales="fixed") + ggtitle("Monthly boxplot by age group: LD cases by date of onset")
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_tsibble %>% filter(AgeGroup2!="Unknown") %>% group_by(AgeGroup2) %>% 
  summarise(cases=sum(nb)) %>% as_tibble() %>% 
  mutate(year=year(week), year=as.character(year), year=reorder(year, desc(year)),
         week=as.character(week), week=substring(week,7)) %>% group_by(AgeGroup2, week) %>% 
  summarise(cases=sum(cases)) %>% mutate(rel_cases=cases/first(cases)) %>% filter(week!="53") %>% 
  ggplot(aes(x=week, y=rel_cases, group=AgeGroup2,color=AgeGroup2)) + geom_line() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim=c(0, NA)) +
  ggtitle("Weekly LD cases (relative to week 1) by week and age group")
ggplotly(p)

## 65 age groups
p <- legi_newage %>% filter(AgeGroup3!="Unknown") %>% group_by(AgeGroup3) %>% 
  summarise(cases=sum(nb)) %>% as_tibble() %>% 
  mutate(year=year(week), year=as.character(year), year=reorder(year, desc(year)),
         week=as.character(week), week=substring(week,7)) %>% group_by(AgeGroup3, week) %>% 
  summarise(cases=sum(cases)) %>% mutate(rel_cases=cases/first(cases)) %>% filter(week!="53") %>% 
  ggplot(aes(x=week, y=rel_cases, group=AgeGroup3,color=AgeGroup3)) + geom_line() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim=c(0, NA)) +
  ggtitle("Cases (relative to week 1) by week and age group")
ggplotly(p)
```


### By gender
```{r seasonality by gender,results="asis"}
p <- legi_tsibble %>% group_by(Gender) %>% summarise(cases=sum(nb)) %>%  
  filter(!is.na(Gender) & Gender!="UNK") %>%  gg_season(cases) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) + 
  scale_x_yearweek(breaks="4 weeks", date_labels="%W", expand = c(0, 0)) +
  ggtitle("Weekly plot by gender: LD cases by date of onset")
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% group_by(Gender) %>% summarise(cases=sum(nb)) %>% 
  filter(!is.na(Gender) & Gender!="UNK") %>% gg_subseries(cases) + 
  ggtitle("Monthly subseries plot by gender: LD cases by date of onset") +
  scale_x_yearweek(breaks="2 years", date_labels="%Y") + theme(axis.text.x=element_text(angle=90))
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_monthly %>% mutate(year=year(month), month2=format(month, format="%m")) %>% 
  group_by(month2, year, Gender) %>% summarise(cases=sum(nb)) %>% 
  filter(!is.na(Gender) & Gender!="UNK") %>% 
  ggplot(aes(x=month2, y=cases, group=month2)) + geom_boxplot() +
  scale_x_discrete(labels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  facet_wrap(~Gender, scales="fixed") + ggtitle("Monthly boxplot by gender: LD cases by date of onset")
ggplotly(p + ylab(NULL) + xlab(NULL))

p <- legi_tsibble %>% filter(Gender!="UNK") %>% group_by(Gender) %>% 
  summarise(cases=sum(nb)) %>% as_tibble() %>% 
  mutate(year=year(week), year=as.character(year), year=reorder(year, desc(year)),
         week=as.character(week), week=substring(week,7)) %>% group_by(Gender, week) %>% 
  summarise(cases=sum(cases)) %>% mutate(rel_cases=cases/first(cases)) %>% filter(week!="53") %>% 
  ggplot(aes(x=week, y=rel_cases, group=Gender,color=Gender)) + geom_line() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    theme(axis.line = element_line(colour = "#767171")) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim=c(0, NA)) +
  ggtitle("Weekly LD cases (relative to week 1) by week and gender")
ggplotly(p)
```


## Part 3: Clusters {.tabset}
### All cases
```{r full, results="asis"}
europe <- legi_tsibble %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
p <- ggplotly(p)
p %>% layout(xaxis = x_year)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis_fun(forecast_europe, model_europe)
```

### Without PT 2014 outbreak
```{r nopt, results="asis"}
europe <- leginopt_tsibble %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(leginopt_tsibble$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/pred_withoutPT.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)


```

###  Without cluster cases
```{r nocluster, results="asis"}
europe <- leginoc_tsibble %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(leginoc_tsibble$CountryName),collapse=", "),".",sep=""))

analysis_fun(forecast_europe, model_europe)
```

### With only cluster cases (no PT 2014)
```{r ocluster, results="asis"}
europe <- legic_tsibble %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legic_tsibble$CountryName),collapse=", "),".",sep=""))

analysis_fun(forecast_europe, model_europe)
```

### With Germany
```{r cluster with Germany, results='asis'}
europe <- legide_tsibble %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legic_tsibble$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/pred_withGermany.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)
```



## Part 4: 2017-2019 forecast {.tabset}

### Europe {.tabset}
#### All cases

```{r europe tsibble, results="asis"}
## Europe tsibble
europe <- legi_tsibble %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,1)+PDQ(0,0,0)))

## create forecast
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred.pdf",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)
```




#### Imported

```{r Imported tsibble, results="asis"}
## Imported tsibble
europe <- legi_tsibble %>%
  filter(Imported3=="Imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=7)+0+pdq(0,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_imported.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)

```


#### Not imported

```{r not imported tsibble, results="asis"}
## unknown tsibble
europe <- legi_tsibble %>%
  filter(Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_domestic.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)


```





#### <40

```{r age_40 tsibble, results="asis"}
## age_40 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(0,0,0)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_40.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)

```


#### 40-49

```{r age_40_49 tsibble,results="asis"}
## age_40_49 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=4)+1+pdq(1,0,0)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_4049.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)


```


#### 50-59

```{r age_50_59 tsibble,results="asis"}
## age_50_59 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,3)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_5059.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)


```


#### 60-69

```{r age_60_69 tsibble,results="asis"}
## age_60_69 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(1,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_6069.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)


```


#### 70-79

```{r age_70_79 tsibble,results="asis"}
## age_70_79 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(0,1,2)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_7079.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)

```



#### 80>=

```{r age_80 tsibble,results="asis"}
## age_80 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(0,1,1)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_80.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)


```


#### Male

```{r male tsibble,results="asis"}
## male tsibble
europe <- legi_tsibble %>%
  filter(Gender=="M") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=4)+1+pdq(0,1,3)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_male.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)


```



#### Female

```{r female tsibble,results="asis"}
## female tsibble
europe <- legi_tsibble %>%
  filter(Gender=="F") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

## fit best model
model_europe <- filter_index(europe,.~"2016 W52") %>%
  model(ARIMA(log(cases+1)~fourier(K=3)+1+pdq(0,1,2)+PDQ(0,0,0)))

## create forecast for 2018
forecast_europe <- forecast(model_europe,h=156) %>% 
  ## include 80% and 90% confidence intervals
  hilo(level=c(80,95)) %>% unpack_hilo("80%") %>% unpack_hilo("95%") %>% 
  rename(
    upper_95 = '95%_upper',
    upper_80 = '80%_upper',
    lower_95 = '95%_lower',
    lower_80 = '80%_lower')

## add observed cases for 2018 to forecast
forecast_europe$observed <- europe1719$cases

## plot the foreacst
p <- ECDC_plot(forecast_europe, europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/1719pred_female.png",sep=""),plot=p,width=10,height=5,units="in")

analysis_fun(forecast_europe, model_europe)


```



### Italy {.tabset}
#### All cases

```{r Italy tsibble,results="asis"}
## Italy tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### Imported

```{r it_Imported tsibble,results="asis"}
## it_Imported tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & Imported3=="Imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```





#### Not imported

```{r it_unknown tsibble,results="asis"}
## it_unknown tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```




#### <40

```{r italy_age_40 tsibble,results="asis"}
## italy_age_40 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 40-49

```{r italy_age_40_49 tsibble,results="asis"}
## italy_age_40_49 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 50-59

```{r italy_age_50_59 tsibble,results="asis"}
## italy_age_50_59 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 60-69

```{r italy_age_60_69 tsibble,results="asis"}
## italy_age_60_69 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 70-79

```{r italy_age_70_79 tsibble,results="asis"}
## italy_age_70_79 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 80>=

```{r italy_age_80 tsibble,results="asis"}
## italy_age_80 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### Male

```{r italy_male tsibble,results="asis"}
## italy_male tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & Gender=="M") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### Female

```{r italy_female tsibble,results="asis"}
## female tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy" & Gender=="F") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



### France {.tabset}
#### All cases

```{r France tsibble,results="asis"}
## France tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### Imported

```{r fr_Imported tsibble,results="asis"}
## fr_Imported tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & Imported3=="Imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```




#### Not imported

```{r fr_unknown tsibble,results="asis"}
## fr_unknown tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### <40

```{r france_age_40 tsibble,results="asis"}
## france_age_40 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### 40-49

```{r france_age_40_49 tsibble,results="asis"}
## france_age_40_49 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 50-59

```{r france_age_50_59 tsibble,results="asis"}
## france_age_50_59 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 60-69

```{r france_age_60_69 tsibble,results="asis"}
## france_age_60_69 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 70-79

```{r france_age_70_79 tsibble,results="asis"}
## france_age_70_79 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 80>=

```{r france_age_80 tsibble,results="asis"}
## france_age_80 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### Male

```{r france_male tsibble,results="asis"}
## france_male tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & Gender=="M") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### Female

```{r france_female tsibble,results="asis"}
## france_female tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France" & Gender=="F") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```




### Spain {.tabset}
#### All cases

```{r spain tsibble,results="asis"}
## Spain tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```




#### Imported

```{r es_Imported tsibble,results="asis"}
## es_Imported tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & Imported3=="Imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```




#### Not imported

```{r es_unknown tsibble,results="asis"}
## es_unknown tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### <40

```{r spain_age_40 tsibble,results="asis"}
## spain_age_40 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 40-49

```{r spain_age_40_49 tsibble,results="asis"}
## spain_age_40_49 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### 50-59

```{r spain_age_50_59 tsibble,results="asis"}
## spain_age_50_59 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 60-69

```{r spain_age_60_69 tsibble,results="asis"}
## spain_age_60_69 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### 70-79

```{r spain_age_70_79 tsibble,results="asis"}
## spain_age_70_79 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 80>=

```{r spain_age_80 tsibble,results="asis"}
## spain_age_80 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### Male

```{r spain_male tsibble,results="asis"}
## spain_male tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & Gender=="M") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### Female

```{r spain_female tsibble,results="asis"}
## spain_female tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain" & Gender=="F") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```




### Netherlands {.tabset}
#### All cases

```{r netherlands tsibble,results="asis"}
## Netherlands tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### Imported

```{r nl_Imported tsibble,results="asis"}
## nl_Imported tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & Imported3=="Imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```




#### Not imported

```{r nl_unknown tsibble,results="asis"}
## nl_unknown tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### <40

```{r netherlands_age_40 tsibble,results="asis"}
## netherlands_age_40 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 40-49

```{r netherlands_age_40_49 tsibble,results="asis"}
## netherlands_age_40_49 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### 50-59

```{r netherlands_age_50_59 tsibble,results="asis"}
## netherlands_age_50_59 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 60-69

```{r netherlands_age_60_69 tsibble,results="asis"}
## netherlands_age_60_69 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```

#### 70-79

```{r netherlands_age_70_79 tsibble,results="asis"}
## netherlands_age_70_79 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 80>=

```{r netherlands_age_80 tsibble,results="asis"}
## netherlands_age_80 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### Male

```{r netherlands_male tsibble,results="asis"}
## netherlands_male tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & Gender=="M") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### Female

```{r netherlands_female tsibble,results="asis"}
## netherlands_female tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands" & Gender=="F") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



### United Kingdom {.tabset}
#### All cases
```{r uk tsibble,results="asis"}
## United Kingdom tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```





#### Imported

```{r uk_Imported tsibble,results="asis"}
## uk_Imported tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & Imported3=="Imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### Not imported

```{r uk_unknown tsibble,results="asis"}
## uk_unknown tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### <40

```{r uk_age_40 tsibble,results="asis"}
## uk_age_40 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 40-49

```{r uk_age_40_49 tsibble,results="asis"}
## uk_age_40_49 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 50-59

```{r uk_age_50_59 tsibble,results="asis"}
## uk_age_50_59 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 60-69

```{r uk_age_60_69 tsibble,results="asis"}
## uk_age_60_69 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### 70-79

```{r uk_age_70_79 tsibble,results="asis"}
## uk_age_70_79 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



#### 80>=

```{r uk_age_80 tsibble,results="asis"}
## uk_age_80 tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### Male

```{r uk_male tsibble,results="asis"}
## uk_male tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & Gender=="M") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


#### Female

```{r uk_female tsibble,results="asis"}
## uk_female tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom" & Gender=="F") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



### Czechia

```{r czechia tsibble,results="asis"}
## Czechia tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Czechia") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



### Portugal

```{r portugal tsibble,results="asis"}
## Portugal tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Portugal") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



### Austria

```{r austria tsibble,results="asis"}
## Austria tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Austria") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


### Denmark

```{r denmark tsibble,results="asis"}
## Denmark tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Denmark") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```




### Sweden

```{r Sweden tsibble,results="asis"}
## Sweden tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Sweden") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```



### Slovenia

```{r slovenia tsibble,results="asis"}
## Slovenia tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Slovenia") %>%
  summarise(cases=sum(nb))
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

dec_fun(europe)
ggplotly(p)

for_fun(europe, europe1719)
ggplotly(p)

analysis_fun(forecast_europe, model_europe)
```


## Part 5: Only 2019 forecast {.tabset}

### All cases

```{r tsibble 2019,results="asis"}
europe <- legi_tsibble %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/19pred.png",sep=""),plot=p,width=10,height=5,units="in")

analysis19_fun(forecast_europe, model_europe)
```

$~$


### Imported

```{r Imported tsibble 2019,results="asis"}
## Imported tsibble
europe <- legi_tsibble %>%
  filter(Imported3=="Imported") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```

$~$


### Not imported

```{r unknown tsibble 2019,results="asis"}
## unknown tsibble
europe <- legi_tsibble %>%
  filter(Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```

$~$

### Italy

```{r italy tsibble 2019,results="asis"}
## italy tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Italy") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

analysis19_fun(forecast_europe, model_europe)
```

$~$
### France

```{r france tsibble 2019,results="asis"}
## france tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="France") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

analysis19_fun(forecast_europe, model_europe)
```

$~$

### Spain

```{r spain tsibble 2019,results="asis"}
## spain tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Spain") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

analysis19_fun(forecast_europe, model_europe)
```

$~$


### Netherlands

```{r netherlands tsibble 2019,results="asis"}
## netherlands tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="Netherlands") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

analysis19_fun(forecast_europe, model_europe)
```

$~$

### United Kingdom

```{r uk tsibble 2019,results="asis"}
## uk tsibble
europe <- legi_tsibble %>%
  filter(CountryName=="United Kingdom") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

analysis19_fun(forecast_europe, model_europe)
```

$~$

### <40

```{r age_40 tsibble 2019,results="asis"}
## age_40 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```

$~$

### 40-49

```{r age_40_49 tsibble 2019,results="asis"}
## age_40_49 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```

$~$

### 50-59

```{r age_50_59 tsibble 2019,results="asis"}
## age_50_59 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```

$~$


### 60-69

```{r age_60_69 tsibble 2019,results="asis"}
## age_60_69 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```

$~$

### 70-79

```{r age_70_79 tsibble 2019,results="asis"}
## age_70_79 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```

$~$

### 80>=

```{r age_80 tsibble 2019,results="asis"}
## age_80 tsibble
europe <- legi_tsibble %>%
  filter(AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```

$~$

### Male

```{r male tsibble 2019,results="asis"}
## male tsibble
europe <- legi_tsibble %>%
  filter(Gender=="M") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```

$~$


### Female

```{r female tsibble 2019,results="asis"}
## female tsibble
europe <- legi_tsibble %>%
  filter(Gender=="F") %>%
  summarise(cases=sum(nb))
europe19 <- europe %>%
  filter_index("2019 W01"~.)

for19_fun(europe, europe19)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

analysis19_fun(forecast_europe, model_europe)
```



## Part 6: Interrupted time series {.tabset}
### All cases
```{r its analysis,results="asis"}
## Europe tsibble
europe <- legi_tsibble %>%
  summarise(cases=sum(nb))
## Europe 2017-19 tsibble
europe1719 <- europe %>%
  filter_index("2017 W01"~.)

its_fun(europe)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its.pdf",sep=""),plot=p,width=10,height=5,units="in")

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```



### Imported 

```{r its Imported,results="asis"}
## Imported tsibble
Imported <- legi_tsibble %>%
  filter(Imported3=="Imported") %>%
  summarise(cases=sum(nb))
## Imported 2018 tsibble
Imported2018 <- Imported %>%
  filter_index("2017 W01"~.)

its_fun(Imported)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_imported.png",sep=""),plot=p,width=10,height=5,units="in")

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```



### Not imported
```{r its Not imported,results="asis"}
## unknown tsibble
unknown <- legi_tsibble %>%
  filter(Imported3=="Not imported") %>%
  summarise(cases=sum(nb))
## unknown 2018 tsibble
unknown2018 <- unknown %>%
  filter_index("2017 W01"~.)

its_fun(unknown)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_domestic.png",sep=""),plot=p,width=10,height=5,units="in")

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### Italy
```{r its italy,results="asis"}
## italy tsibble
italy <- legi_tsibble %>%
  filter(CountryName=="Italy") %>%
  summarise(cases=sum(nb))
## italy 2018 tsibble
italy2018 <- italy %>%
  filter_index("2017 W01"~.)

its_fun(italy)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```

### France
```{r its france,results="asis"}
## france tsibble
france <- legi_tsibble %>%
  filter(CountryName=="France") %>%
  summarise(cases=sum(nb))
## france 2018 tsibble
france2018 <- france %>%
  filter_index("2017 W01"~.)

its_fun(france)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```

### Spain
```{r its spain,results="asis"}
## spain tsibble
spain <- legi_tsibble %>%
  filter(CountryName=="Spain") %>%
  summarise(cases=sum(nb))
## spain 2018 tsibble
spain2018 <- spain %>%
  filter_index("2017 W01"~.)

its_fun(spain)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```


### Netherlands
```{r its netherlands,results="asis"}
## netherlands tsibble
netherlands <- legi_tsibble %>%
  filter(CountryName=="Netherlands") %>%
  summarise(cases=sum(nb))
## netherlands 2018 tsibble
netherlands2018 <- netherlands %>%
  filter_index("2017 W01"~.)

its_fun(netherlands)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```

### United Kingdom
```{r its uk,results="asis"}
## uk tsibble
uk <- legi_tsibble %>%
  filter(CountryName=="United Kingdom") %>%
  summarise(cases=sum(nb))
## uk 2018 tsibble
uk2018 <- uk %>%
  filter_index("2017 W01"~.)

its_fun(uk)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```


### Czechia
```{r its Czechia,results="asis"}
## uk tsibble
uk <- legi_tsibble %>%
  filter(CountryName=="Czechia") %>%
  summarise(cases=sum(nb))
## uk 2018 tsibble
uk2018 <- uk %>%
  filter_index("2017 W01"~.)

its_fun(uk)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```

### Portugal
```{r its Portugal,results="asis"}
## uk tsibble
uk <- legi_tsibble %>%
  filter(CountryName=="Portugal") %>%
  summarise(cases=sum(nb))
## uk 2018 tsibble
uk2018 <- uk %>%
  filter_index("2017 W01"~.)

its_fun(uk)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```

### Austria
```{r its Austria,results="asis"}
## uk tsibble
uk <- legi_tsibble %>%
  filter(CountryName=="Austria") %>%
  summarise(cases=sum(nb))
## uk 2018 tsibble
uk2018 <- uk %>%
  filter_index("2017 W01"~.)

its_fun(uk)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```

### Denmark
```{r its Denmark,results="asis"}
## uk tsibble
uk <- legi_tsibble %>%
  filter(CountryName=="Denmark") %>%
  summarise(cases=sum(nb))
## uk 2018 tsibble
uk2018 <- uk %>%
  filter_index("2017 W01"~.)

its_fun(uk)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```


### Sweden
```{r its Sweden,results="asis"}
## uk tsibble
uk <- legi_tsibble %>%
  filter(CountryName=="Sweden") %>%
  summarise(cases=sum(nb))
## uk 2018 tsibble
uk2018 <- uk %>%
  filter_index("2017 W01"~.)

its_fun(uk)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```


### Slovenia
```{r its Slovenia,results="asis"}
## uk tsibble
uk <- legi_tsibble %>%
  filter(CountryName=="Slovenia") %>%
  summarise(cases=sum(nb))
## uk 2018 tsibble
uk2018 <- uk %>%
  filter_index("2017 W01"~.)

its_fun(uk)
ggplotly(p)

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)
```

### <40
```{r its age40,results="asis"}
## age40 tsibble
age40 <- legi_tsibble %>%
  filter(AgeGroup2=="<40") %>%
  summarise(cases=sum(nb))
## age40 2018 tsibble
age402018 <- age40 %>%
  filter_index("2017 W01"~.)

its_fun(age40)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_40.png",sep=""),plot=p,width=10,height=5,units="in")


its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### 40-49
```{r its age4049,results="asis"}
## age4049 tsibble
age4049 <- legi_tsibble %>%
  filter(AgeGroup2=="40-49") %>%
  summarise(cases=sum(nb))
## age4049 2018 tsibble
age40492018 <- age4049 %>%
  filter_index("2017 W01"~.)

its_fun(age4049)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_4049.png",sep=""),plot=p,width=10,height=5,units="in")


its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)

```

### 50-59
```{r its age5059,results="asis"}
## age5059 tsibble
age5059 <- legi_tsibble %>%
  filter(AgeGroup2=="50-59") %>%
  summarise(cases=sum(nb))
## age5059 2018 tsibble
age50592018 <- age5059 %>%
  filter_index("2017 W01"~.)

its_fun(age5059)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_5059.png",sep=""),plot=p,width=10,height=5,units="in")

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### 60-69
```{r its age6069,results="asis"}
## age6069 tsibble
age6069 <- legi_tsibble %>%
  filter(AgeGroup2=="60-69") %>%
  summarise(cases=sum(nb))
## age6069 2018 tsibble
age60692018 <- age6069 %>%
  filter_index("2017 W01"~.)

its_fun(age6069)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_6069.png",sep=""),plot=p,width=10,height=5,units="in")

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### 70-79
```{r its age7079,results="asis"}
## age7079 tsibble
age7079 <- legi_tsibble %>%
  filter(AgeGroup2=="70-79") %>%
  summarise(cases=sum(nb))
## age7079 2018 tsibble
age70792018 <- age7079 %>%
  filter_index("2017 W01"~.)

its_fun(age7079)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_7079.png",sep=""),plot=p,width=10,height=5,units="in")

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### 80>=
```{r its age80,results="asis"}
## age80 tsibble
age80 <- legi_tsibble %>%
  filter(AgeGroup2=="80>=") %>%
  summarise(cases=sum(nb))
## age80 2018 tsibble
age802018 <- age80 %>%
  filter_index("2017 W01"~.)

its_fun(age80)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_80.png",sep=""),plot=p,width=10,height=5,units="in")

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)


```

### Male
```{r its male,results="asis"}
## male tsibble
male <- legi_tsibble %>%
  filter(Gender=="M") %>%
  summarise(cases=sum(nb))
## male 2018 tsibble
male2018 <- male %>%
  filter_index("2017 W01"~.)

its_fun(male)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_male.png",sep=""),plot=p,width=10,height=5,units="in")

its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)

```

### Female
```{r its female,results="asis"}
## female tsibble
female <- legi_tsibble %>%
  filter(Gender=="F") %>%
  summarise(cases=sum(nb))
## female 2018 tsibble
female2018 <- female %>%
  filter_index("2017 W01"~.)

its_fun(female)
ggplotly(p)

cat(paste("Countries included: ",paste(unique(legidata$CountryName),collapse=", "),".",sep=""))

ggsave(filename=paste(PATH,"/Outputs/its_female.png",sep=""),plot=p,width=10,height=5,units="in")


its_table %>% 
  kable(col.names=c("Term", "Estimate", "95% Confidence interval", "P-value"), 
        digits=3) %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
checkresiduals(its_model)

```
